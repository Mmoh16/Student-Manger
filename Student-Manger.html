<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Student Manager Pro - EST1 Adv March</title>
    <link rel="manifest" href="manifest.json">

    <!-- === PRE-LOADERS === -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- === CONFIGURATION === -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: { 50: '#f0fdfa', 100: '#ccfbf1', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e' },
                        surface: '#F8FAFC'
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #F1F5F9; -webkit-tap-highlight-color: transparent; }
        
        /* Smooth Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 3px; }
        
        /* Transitions */
        .card-hover { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        
        /* Loader */
        .loader-ring { display: inline-block; width: 20px; height: 20px; }
        .loader-ring:after { content: " "; display: block; width: 18px; height: 18px; margin: 1px; border-radius: 50%; border: 2px solid #fff; border-color: #fff transparent #fff transparent; animation: lds-dual-ring 1.2s linear infinite; }
        @keyframes lds-dual-ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Mobile Optimizations */
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Toast Animation */
        @keyframes slideIn { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .toast-animate { animation: slideIn 0.3s ease-out forwards; }
    </style>

    <!-- === THIRD PARTY SDKS === -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
          appId: "b58e7b17-b719-486a-9d7b-5cb98d8533c3",
          safari_web_id: "web.onesignal.auto.45e32f52-047f-48ea-8b6f-5a9d2fcde2db",
          notifyButton: { enable: false }, // Custom button used
          path: "/Student-Manger/",
          serviceWorkerParam: { scope: "/Student-Manger/" }, 
        });
        OneSignal.User.addTag("course", "EST1 Adv March");
      });
    </script>
    
    <script
        async crossorigin="anonymous"
        data-clerk-publishable-key="pk_test_ZXhjaXRpbmctbWFzdGlmZi04MC5jbGVyay5hY2NvdW50cy5kZXYk"
        src="https://exciting-mastiff-80.clerk.accounts.dev/npm/@clerk/clerk-js@5/dist/clerk.browser.js"
        type="text/javascript">
    </script>
    
    <script src="teacher_guard.js"></script>
</head>
<body class="text-slate-800 antialiased hidden" id="appBody">

    <!-- === NAVIGATION BAR === -->
    <nav class="bg-white sticky top-0 z-30 border-b border-slate-200 shadow-sm backdrop-blur-lg bg-white/90">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <!-- Logo & Brand -->
                <div class="flex items-center gap-3">
                    <div class="bg-primary-50 p-2 rounded-lg text-primary-600">
                        <i class="fas fa-graduation-cap text-xl"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-slate-800 text-lg leading-none">EST1 Manager</h1>
                        <span class="text-xs text-slate-500 font-medium">Adv March Cohort</span>
                    </div>
                    <!-- Sync Indicator -->
                    <span id="syncIndicator" class="hidden ml-2 px-2 py-0.5 bg-blue-50 text-blue-600 text-[10px] uppercase font-bold tracking-wider rounded-full flex items-center gap-1">
                        <i class="fas fa-sync fa-spin"></i> Syncing
                    </span>
                </div>

                <!-- Desktop Actions -->
                <div class="flex items-center gap-2">
                    <button onclick="requestNotificationPermission()" id="notifyBtn" class="p-2 text-slate-400 hover:text-primary-600 transition rounded-full hover:bg-slate-50 relative">
                        <i class="fas fa-bell"></i>
                    </button>
                    <button onclick="fetchStudents(true)" id="refreshBtn" class="p-2 text-slate-400 hover:text-primary-600 transition rounded-full hover:bg-slate-50">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <div class="h-6 w-px bg-slate-200 mx-1 hidden sm:block"></div>
                    <button onclick="openAddModal()" class="hidden sm:flex bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-md shadow-primary-500/30 transition items-center gap-2">
                        <i class="fas fa-plus"></i> New Student
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Search & Filter Bar -->
        <div class="bg-white border-b border-slate-100 py-3 px-4 sm:px-6 lg:px-8">
            <div class="max-w-7xl mx-auto flex flex-col sm:flex-row gap-3 items-center justify-between">
                <!-- Search -->
                <div class="relative w-full sm:max-w-md">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-slate-400"></i>
                    </div>
                    <input type="text" id="searchInput" class="block w-full pl-10 pr-3 py-2 border border-slate-200 rounded-lg leading-5 bg-slate-50 placeholder-slate-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm transition shadow-sm" placeholder="Search students by name, phone...">
                </div>

                <!-- View Toggle -->
                <div class="flex gap-2 w-full sm:w-auto">
                    <div class="bg-slate-100 p-1 rounded-lg flex w-full sm:w-auto">
                        <button onclick="switchTab('active')" id="tab-active" class="flex-1 sm:flex-none px-4 py-1.5 rounded-md text-sm font-medium transition-all text-slate-600 hover:text-slate-900 active-tab">
                            Active <span id="count-active" class="ml-1 text-xs bg-slate-200 px-1.5 py-0.5 rounded-full text-slate-600">0</span>
                        </button>
                        <button onclick="switchTab('pending')" id="tab-pending" class="flex-1 sm:flex-none px-4 py-1.5 rounded-md text-sm font-medium transition-all text-slate-600 hover:text-slate-900">
                            Pending <span id="count-pending" class="ml-1 text-xs bg-orange-100 px-1.5 py-0.5 rounded-full text-orange-600">0</span>
                        </button>
                        <button onclick="switchTab('removed')" id="tab-removed" class="flex-1 sm:flex-none px-4 py-1.5 rounded-md text-sm font-medium transition-all text-slate-600 hover:text-slate-900">
                            Removed
                        </button>
                    </div>
                    <button onclick="toggleViewMode()" class="bg-white border border-slate-200 text-slate-500 hover:text-primary-600 px-3 py-2 rounded-lg shadow-sm transition hidden sm:block">
                        <i class="fas fa-list" id="viewIcon"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- === MAIN CONTENT === -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 pb-24 safe-bottom">
        
        <!-- Skeleton Loader (Visible initially) -->
        <div id="skeletonLoader" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Repeats via JS -->
        </div>

        <!-- Content Grids -->
        <div id="activeGrid" class="hidden grid-container gap-6"></div>
        <div id="pendingGrid" class="hidden grid-container gap-6"></div>
        <div id="removedGrid" class="hidden grid-container gap-6"></div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-12 text-center">
            <div class="bg-slate-100 p-6 rounded-full mb-4">
                <i class="fas fa-user-graduate text-4xl text-slate-300"></i>
            </div>
            <h3 class="text-lg font-medium text-slate-900">No students found</h3>
            <p class="text-slate-500 max-w-sm mt-1">We couldn't find any students matching your current filters or search.</p>
        </div>
    </main>

    <!-- === MOBILE FAB (Floating Action Button) === -->
    <button onclick="openAddModal()" id="mobileFab" class="fixed bottom-6 right-6 w-14 h-14 bg-primary-600 text-white rounded-full shadow-lg shadow-primary-600/40 flex items-center justify-center text-xl z-20 sm:hidden hover:scale-105 transition active:scale-95">
        <i class="fas fa-plus"></i>
    </button>

    <!-- === MODALS === -->
    
    <!-- Edit/Add Modal -->
    <div id="addModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeAddModal()"></div>
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative transform overflow-hidden rounded-2xl bg-white shadow-2xl transition-all sm:w-full sm:max-w-lg w-full">
                <div class="bg-primary-600 px-6 py-4 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white" id="modalTitle">Edit Student</h3>
                    <button onclick="closeAddModal()" class="text-primary-100 hover:text-white transition"><i class="fas fa-times"></i></button>
                </div>
                
                <form id="addForm" class="px-6 py-6 space-y-4">
                    <input type="hidden" id="studentId">
                    
                    <!-- Form Groups -->
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Personal Info</label>
                        <input type="text" id="newName" placeholder="Full Name" required class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-primary-500 focus:bg-white outline-none transition">
                    </div>
                    
                    <input type="email" id="newEmail" placeholder="Email Address" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-primary-500 focus:bg-white outline-none transition">

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Contact</label>
                            <input type="tel" id="newStudentPhone" placeholder="Student Phone" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-primary-500 focus:bg-white outline-none transition">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">&nbsp;</label>
                            <input type="tel" id="newParentPhone" placeholder="Parent Phone" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-primary-500 focus:bg-white outline-none transition">
                        </div>
                    </div>

                    <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                        <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Financials</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="relative">
                                <span class="absolute left-3 top-2.5 text-slate-400">$</span>
                                <input type="number" id="newPaid" placeholder="Paid" class="w-full pl-7 bg-white border border-slate-200 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-green-500 outline-none transition font-medium text-green-700">
                            </div>
                            <div class="relative">
                                <span class="absolute left-3 top-2.5 text-slate-400">$</span>
                                <input type="number" id="newRemaining" placeholder="Remaining" class="w-full pl-7 bg-white border border-slate-200 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-red-500 outline-none transition font-medium text-red-600">
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-3 pt-4 border-t border-slate-100">
                        <button type="button" id="deleteBtn" onclick="deleteStudentAction(this)" class="px-4 py-2.5 text-red-600 bg-red-50 hover:bg-red-100 rounded-lg font-semibold transition text-sm">Delete</button>
                        <button type="button" id="removeBtn" onclick="removeStudentAction(this)" class="px-4 py-2.5 text-orange-600 bg-orange-50 hover:bg-orange-100 rounded-lg font-semibold transition text-sm">Archive</button>
                        <div class="flex-1"></div>
                        <button type="button" onclick="closeAddModal()" class="px-4 py-2.5 text-slate-600 hover:text-slate-800 font-semibold transition text-sm">Cancel</button>
                        <button type="submit" id="submitBtn" class="px-6 py-2.5 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-bold shadow-lg shadow-primary-500/30 transition text-sm flex items-center gap-2">
                            <span>Save Changes</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="closeImageModal()"></div>
        <div class="relative z-10 max-w-md w-full p-4 transform scale-95 transition-transform duration-300">
            <button onclick="closeImageModal()" class="absolute -top-10 right-0 text-white text-2xl hover:text-gray-300"><i class="fas fa-times"></i></button>
            <img id="modalImage" src="" class="w-full h-auto rounded-lg shadow-2xl border-4 border-white">
            <p class="text-center text-white/70 mt-2 font-mono text-sm" id="modalStudentId"></p>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-[70] flex flex-col gap-2 w-max max-w-sm pointer-events-none"></div>

    <!-- === LOGIC === -->
    <script>
        // ================= STYLE HELPER =================
        // Dynamic classes based on state
        const STYLES = {
            activeTab: 'bg-white text-primary-700 shadow-sm ring-1 ring-slate-200',
            inactiveTab: 'text-slate-500 hover:text-slate-700 hover:bg-slate-50',
            grid: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3',
            list: 'flex flex-col'
        };

        // ================= CONFIGURATION =================
        const BASE_WEBHOOK = 'https://api.mark-attendance.com/webhook/EST1-Adv-March-';
        const URLS = {
            GET:     BASE_WEBHOOK + 'get',
            UPDATE:  BASE_WEBHOOK + 'update',
            REMOVE:  BASE_WEBHOOK + 'remove',
            DELETE:  BASE_WEBHOOK + 'delete',
            APPROVE: BASE_WEBHOOK + 'approve',
            DENY:    BASE_WEBHOOK + 'deny',
            RESTORE: BASE_WEBHOOK + 'restore'
        };

        const DEFAULT_IMAGE = 'https://ui-avatars.com/api/?background=0D9488&color=fff&name=';
        const CACHE_KEY = 'est1_adv_march_data_v2';
        const VIEW_MODE_KEY = 'est1_view_mode_v2';

        // ================= STATE =================
        let allStudents = [];
        let currentTab = 'active'; 
        let viewMode = localStorage.getItem(VIEW_MODE_KEY) || 'grid';

        // DOM Elements
        const grids = {
            active: document.getElementById('activeGrid'),
            pending: document.getElementById('pendingGrid'),
            removed: document.getElementById('removedGrid')
        };
        const counts = {
            active: document.getElementById('count-active'),
            pending: document.getElementById('count-pending'),
            removed: document.getElementById('count-removed')
        };
        const emptyState = document.getElementById('emptyState');
        const searchInput = document.getElementById('searchInput');
        const syncIndicator = document.getElementById('syncIndicator');

        // ================= INIT =================
        document.addEventListener('DOMContentLoaded', () => {
            renderSkeleton(); // Show immediately

            if(window.OneSignalDeferred) {
                window.OneSignalDeferred.push(async function(OneSignal) {
                    const permission = await OneSignal.Notifications.permission;
                    if (permission) updateNotifyIcon(true);
                });
            }

            // Load Cache
            const cached = localStorage.getItem(CACHE_KEY);
            if(cached) {
                try {
                    allStudents = JSON.parse(cached);
                    setTimeout(processAndRender, 100); // Small delay to let shell render
                } catch(e) {}
            }

            updateViewToggleIcon();
            
            // Initial Fetch
            setTimeout(() => fetchStudents(false), 500);
        });

        // ================= FETCHING =================
        async function fetchStudents(force = false) {
            const refreshBtn = document.getElementById('refreshBtn');
            const icon = refreshBtn.querySelector('i');
            
            if(force) {
                icon.classList.add('fa-spin');
                syncIndicator.classList.remove('hidden');
            }

            try {
                const res = await fetch(URLS.GET);
                if(!res.ok) throw new Error('Network error');
                const data = await res.json();
                let rawList = Array.isArray(data) ? data : (data.data || data.body || []);
                
                allStudents = rawList.map((item, idx) => ({
                    id: item.id || item.ID || idx,
                    name: item.Name || "No Name",
                    email: item.Email || "",
                    phone: item["Student Phone"] || "",
                    parentPhone: item["Parent Phone"] || "",
                    paid: parseFloat(item.Paid) || 0,
                    remaining: parseFloat(item.Remaining) || 0,
                    status: (item.Status || "Active").toLowerCase(), 
                    notes: item.Notes || "",
                    ref: item.Reference || item.Ref || "N/A", 
                    image: item.Image, // Will fallback in render
                    joinedDate: item.date || item.Date
                }));

                localStorage.setItem(CACHE_KEY, JSON.stringify(allStudents));
                processAndRender();
                if(force) showToast("List updated successfully", "success");

            } catch(e) {
                console.error(e);
                if(force) showToast("Could not sync data", "error");
            } finally {
                if(force) {
                    setTimeout(() => {
                        icon.classList.remove('fa-spin');
                        syncIndicator.classList.add('hidden');
                    }, 500);
                }
                // Hide Skeleton
                document.getElementById('skeletonLoader').classList.add('hidden');
            }
        }

        // ================= RENDERING =================
        function processAndRender() {
            // Filter
            const term = searchInput.value.toLowerCase();
            const filtered = allStudents.filter(s => 
                !term || 
                s.name.toLowerCase().includes(term) || 
                s.email.toLowerCase().includes(term) ||
                s.phone.includes(term)
            );

            // Split
            const lists = {
                active: filtered.filter(s => s.status === 'active'),
                pending: filtered.filter(s => s.status === 'pending'),
                removed: filtered.filter(s => s.status === 'removed' || s.status === 'denied')
            };

            // Update Counts
            counts.active.innerText = lists.active.length;
            counts.pending.innerText = lists.pending.length;
            counts.removed.innerText = lists.removed.length;

            // Manage Grids
            Object.keys(grids).forEach(key => grids[key].classList.add('hidden'));
            const targetGrid = grids[currentTab];
            const targetList = lists[currentTab];
            
            targetGrid.classList.remove('hidden');
            
            // Grid vs List Class
            targetGrid.className = viewMode === 'grid' 
                ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5' 
                : 'flex flex-col gap-3';

            if(targetList.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                
                if(currentTab === 'active') renderActive(targetList, targetGrid);
                else if(currentTab === 'pending') renderPending(targetList, targetGrid);
                else renderRemoved(targetList, targetGrid);
            }
        }

        function renderActive(list, container) {
            container.innerHTML = list.map((s, idx) => {
                const img = getImage(s);
                const isDebt = s.remaining > 0;
                
                // --- GRID VIEW ---
                if(viewMode === 'grid') return `
                <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-100 card-hover group relative overflow-hidden">
                    ${isDebt ? `<div class="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-bl-lg"></div>` : ''}
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <div class="relative cursor-pointer" onclick="openImageModal('${s.id}', '${img}')">
                                <img src="${img}" class="w-12 h-12 rounded-full object-cover border border-slate-100 bg-slate-50">
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800 text-lg leading-tight truncate w-40">${s.name}</h3>
                                <p class="text-xs text-slate-400 font-mono">${s.id}</p>
                            </div>
                        </div>
                        <button onclick="openEditModal('${s.id}')" class="text-slate-300 hover:text-primary-600 transition"><i class="fas fa-pen"></i></button>
                    </div>

                    <!-- Stats -->
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <div class="bg-slate-50 p-2 rounded-lg border border-slate-100">
                            <p class="text-[10px] uppercase text-slate-400 font-bold">Paid</p>
                            <p class="text-green-600 font-bold">$${s.paid}</p>
                        </div>
                        <div class="bg-slate-50 p-2 rounded-lg border border-slate-100">
                            <p class="text-[10px] uppercase text-slate-400 font-bold">Due</p>
                            <p class="${isDebt ? 'text-red-500' : 'text-slate-400'} font-bold">$${s.remaining}</p>
                        </div>
                    </div>

                    <!-- Note Input -->
                    <div class="relative mb-4">
                        <input type="text" value="${s.notes}" id="note-${idx}" 
                            class="w-full text-sm bg-slate-50 border-none rounded-md py-2 px-3 focus:bg-white focus:ring-1 focus:ring-primary-500 transition placeholder-slate-400" 
                            placeholder="Add a note..."
                            onchange="saveNote('${s.id}', ${idx}, this)">
                        <i class="fas fa-pencil-alt absolute right-3 top-3 text-xs text-slate-300 pointer-events-none"></i>
                    </div>

                    <!-- Quick Actions -->
                    <div class="flex gap-2">
                         <a href="https://wa.me/${s.phone.replace(/^0/, '20')}" target="_blank" class="flex-1 bg-[#25D366]/10 text-[#25D366] hover:bg-[#25D366] hover:text-white py-2 rounded-lg text-center text-sm font-semibold transition flex items-center justify-center gap-2">
                            <i class="fab fa-whatsapp"></i> Student
                        </a>
                        <a href="https://wa.me/${s.parentPhone.replace(/^0/, '20')}" target="_blank" class="px-3 bg-slate-100 text-slate-600 hover:bg-slate-200 py-2 rounded-lg text-sm transition">
                            <i class="fas fa-user-friends"></i>
                        </a>
                    </div>
                </div>`;

                // --- LIST VIEW ---
                return `
                <div class="bg-white rounded-lg p-3 shadow-sm border border-slate-100 flex flex-col sm:flex-row items-center gap-4">
                     <img src="${img}" class="w-10 h-10 rounded-full object-cover bg-slate-50 hidden sm:block">
                     <div class="flex-1 w-full sm:w-auto text-left">
                        <div class="flex justify-between items-center sm:block">
                            <h3 class="font-bold text-slate-800">${s.name}</h3>
                            <span class="sm:hidden text-xs font-bold ${isDebt ? 'text-red-500' : 'text-green-600'}">$${s.remaining} due</span>
                        </div>
                        <p class="text-xs text-slate-500 truncate">${s.email}</p>
                     </div>
                     <div class="hidden sm:block text-right px-4 border-l border-slate-100">
                        <p class="text-xs text-slate-400 uppercase">Paid</p>
                        <p class="font-bold text-slate-700">$${s.paid}</p>
                     </div>
                     <div class="hidden sm:block text-right px-4 border-l border-slate-100">
                        <p class="text-xs text-slate-400 uppercase">Due</p>
                        <p class="font-bold ${isDebt ? 'text-red-500' : 'text-slate-400'}">$${s.remaining}</p>
                     </div>
                     <div class="flex gap-2 w-full sm:w-auto mt-2 sm:mt-0">
                        <a href="https://wa.me/${s.phone}" class="flex-1 sm:flex-none text-center bg-green-50 text-green-600 px-3 py-2 rounded-md hover:bg-green-100 transition"><i class="fab fa-whatsapp"></i></a>
                        <button onclick="openEditModal('${s.id}')" class="flex-1 sm:flex-none bg-slate-50 text-slate-600 px-3 py-2 rounded-md hover:bg-slate-100 transition"><i class="fas fa-pen"></i></button>
                     </div>
                </div>`;
            }).join('');
        }

        function renderPending(list, container) {
            container.innerHTML = list.map(s => `
                <div class="bg-white rounded-xl overflow-hidden shadow-sm border border-orange-200">
                    <div class="bg-orange-50 p-4 flex justify-between items-center">
                        <h3 class="font-bold text-orange-900">${s.name}</h3>
                        <span class="bg-white text-orange-600 text-xs px-2 py-1 rounded font-mono border border-orange-100">${s.ref}</span>
                    </div>
                    <div class="p-5">
                        <div class="flex justify-between mb-4 text-sm">
                            <span class="text-slate-500">Amount Paid:</span>
                            <span class="font-bold text-slate-800">$${s.paid}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                             <button onclick="performAction('approve', '${s.id}', this)" class="bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg text-sm font-bold shadow-sm transition">Approve</button>
                             <button onclick="performAction('deny', '${s.id}', this)" class="bg-white border border-red-200 text-red-600 hover:bg-red-50 py-2 rounded-lg text-sm font-bold transition">Deny</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderRemoved(list, container) {
            container.innerHTML = list.map(s => `
                <div class="bg-slate-50 rounded-xl p-4 border border-slate-200 opacity-75 hover:opacity-100 transition">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-slate-600 line-through">${s.name}</h3>
                        <button onclick="performAction('restore', '${s.id}', this)" class="text-blue-600 hover:text-blue-800 text-xs font-bold uppercase"><i class="fas fa-undo mr-1"></i> Restore</button>
                    </div>
                    <p class="text-xs text-slate-400 mb-2">${s.email}</p>
                    <div class="text-xs bg-slate-200 text-slate-500 px-2 py-1 rounded inline-block">Archived</div>
                </div>
            `).join('');
        }

        function renderSkeleton() {
            const skel = `
            <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-100 animate-pulse">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-12 h-12 bg-slate-200 rounded-full"></div>
                    <div class="flex-1 space-y-2">
                        <div class="h-4 bg-slate-200 rounded w-3/4"></div>
                        <div class="h-3 bg-slate-200 rounded w-1/2"></div>
                    </div>
                </div>
                <div class="h-16 bg-slate-100 rounded-lg mb-4"></div>
                <div class="h-8 bg-slate-200 rounded"></div>
            </div>`;
            document.getElementById('skeletonLoader').innerHTML = skel.repeat(6);
        }

        // ================= ACTIONS =================
        async function performAction(action, id, btn) {
            if(action === 'delete' && !confirm("Permanently delete this student?")) return;
            
            const originalContent = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i>`;
            btn.disabled = true;

            const student = allStudents.find(s => s.id == id);
            const body = { id, Date: student ? student.joinedDate : null };

            try {
                let url = URLS[action.toUpperCase()];
                await fetch(url, { method: 'POST', body: JSON.stringify(body) });
                
                showToast(`${action} successful`, 'success');
                // Optimistic UI update could go here, but for safety we sync
                setTimeout(() => fetchStudents(true), 2000); 

                // Close modals if open
                closeAddModal();

            } catch(e) {
                btn.innerHTML = originalContent;
                btn.disabled = false;
                showToast("Action failed", "error");
            }
        }

        async function saveNote(id, idx, input) {
            const val = input.value;
            // 1. Get the current user's name from Clerk
            const editor = window.Clerk?.user ? (window.Clerk.user.firstName || window.Clerk.user.fullName || "Admin") : "Admin";
            // 2. Create timestamp
            const time = new Date().toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric' });
            // 3. Append signature to note
            const signedNote = `${val} - [${editor} @ ${time}]`;

            // Visual feedback
            input.classList.add('bg-green-50', 'text-green-700');
            input.value = signedNote; 

            try {
                await fetch(URLS.UPDATE, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        id: id, 
                        Notes: signedNote, // Sending signed note
                        Date: allStudents.find(s => s.id == id)?.joinedDate 
                    })
                });

                // Update local model
                allStudents.find(s => s.id == id).notes = signedNote;
                
                showToast(`Note signed by ${editor}`, 'success');
                setTimeout(() => input.classList.remove('bg-green-50', 'text-green-700'), 1500);
            } catch(e) {
                input.value = val; // Revert
                input.classList.add('bg-red-50', 'text-red-700');
                showToast("Failed to save note", "error");
            }
        }

        // Form Submit
        document.getElementById('addForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const original = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Saving...`;
            btn.disabled = true;

            const idVal = document.getElementById('studentId').value;
            const existing = allStudents.find(s => s.id == idVal);
            
            // Get Editor for main updates too (optional but good for tracking)
            const editor = window.Clerk?.user ? (window.Clerk.user.firstName || "Admin") : "Admin";

            const payload = {
                id: idVal,
                Name: document.getElementById('newName').value,
                Email: document.getElementById('newEmail').value,
                "Student Phone": document.getElementById('newStudentPhone').value,
                "Parent Phone": document.getElementById('newParentPhone').value,
                Paid: document.getElementById('newPaid').value,
                Remaining: document.getElementById('newRemaining').value,
                Status: 'Active',
                Date: existing ? existing.joinedDate : new Date().toISOString(),
                UpdatedBy: editor // Extra tracking field
            };

            try {
                await fetch(URLS.UPDATE, { method: 'POST', body: JSON.stringify(payload) });
                showToast("Student saved successfully", "success");
                closeAddModal();
                setTimeout(() => fetchStudents(true), 3000);
            } catch(e) {
                showToast("Save failed", "error");
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        });

        // ================= HELPERS =================
        function getImage(s) {
            let url = s.image;
            if(Array.isArray(url)) url = url[0]?.url;
            if(!url || typeof url !== 'string') return DEFAULT_IMAGE + encodeURIComponent(s.name);
            
            // Google Drive Fix
            const match = url.match(/\/d\/([-\w]+)/) || url.match(/id=([-\w]+)/);
            if(match && match[1]) return `https://lh3.googleusercontent.com/d/${match[1]}=s200`;
            
            return url;
        }

        // UI Helpers
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('button[id^="tab-"]').forEach(b => {
                b.className = b.id === `tab-${tab}` 
                    ? `flex-1 sm:flex-none px-4 py-1.5 rounded-md text-sm font-medium transition-all ${STYLES.activeTab}`
                    : `flex-1 sm:flex-none px-4 py-1.5 rounded-md text-sm font-medium transition-all ${STYLES.inactiveTab}`;
            });
            processAndRender();
        }

        function toggleViewMode() {
            viewMode = viewMode === 'grid' ? 'list' : 'grid';
            localStorage.setItem(VIEW_MODE_KEY, viewMode);
            updateViewToggleIcon();
            processAndRender();
        }

        function updateViewToggleIcon() {
            const icon = document.getElementById('viewIcon');
            icon.className = viewMode === 'grid' ? 'fas fa-list' : 'fas fa-th-large';
        }

        // Modal Logic
        function openAddModal() {
            document.getElementById('addForm').reset();
            document.getElementById('studentId').value = "";
            document.getElementById('modalTitle').innerText = "Add New Student";
            document.getElementById('deleteBtn').classList.add('hidden');
            document.getElementById('removeBtn').classList.add('hidden');
            document.getElementById('addModal').classList.remove('hidden');
        }

        function openEditModal(id) {
            const s = allStudents.find(x => x.id == id);
            if(!s) return;
            document.getElementById('studentId').value = s.id;
            document.getElementById('newName').value = s.name;
            document.getElementById('newEmail').value = s.email;
            document.getElementById('newStudentPhone').value = s.phone;
            document.getElementById('newParentPhone').value = s.parentPhone;
            document.getElementById('newPaid').value = s.paid;
            document.getElementById('newRemaining').value = s.remaining;
            
            document.getElementById('modalTitle').innerText = "Edit Details";
            document.getElementById('deleteBtn').classList.remove('hidden');
            document.getElementById('removeBtn').classList.remove('hidden');
            document.getElementById('addModal').classList.remove('hidden');
        }

        function closeAddModal() { document.getElementById('addModal').classList.add('hidden'); }
        
        // Image Modal
        function openImageModal(id, url) {
            const m = document.getElementById('imageModal');
            document.getElementById('modalImage').src = url;
            document.getElementById('modalStudentId').innerText = id;
            m.classList.remove('hidden');
            setTimeout(() => { m.classList.remove('opacity-0'); m.children[1].classList.remove('scale-95'); }, 10);
        }
        function closeImageModal() {
             const m = document.getElementById('imageModal');
             m.classList.add('opacity-0'); m.children[1].classList.add('scale-95');
             setTimeout(() => m.classList.add('hidden'), 300);
        }

        // Search Debounce
        searchInput.addEventListener('input', () => processAndRender());

        // Notifications
        function requestNotificationPermission() {
            window.OneSignalDeferred.push(async function(OneSignal) {
                await OneSignal.Notifications.requestPermission();
                updateNotifyIcon(true);
            });
        }
        function updateNotifyIcon(active) {
            const btn = document.getElementById('notifyBtn');
            if(active) {
                btn.classList.add('text-primary-600', 'bg-primary-50');
                btn.querySelector('i').classList.replace('fa-bell', 'fa-bell-slash');
            }
        }
        
        // Action Wrappers
        function deleteStudentAction(btn) { performAction('delete', document.getElementById('studentId').value, btn); }
        function removeStudentAction(btn) { performAction('remove', document.getElementById('studentId').value, btn); }
        
        function showToast(msg, type) {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            const bg = type === 'success' ? 'bg-slate-800' : 'bg-red-600';
            t.className = `${bg} text-white px-4 py-3 rounded-lg shadow-lg text-sm flex items-center gap-3 toast-animate pointer-events-auto`;
            t.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i> ${msg}`;
            c.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
    </script>
    
    <!-- Auth Check -->
    <script>
        const LOGIN_PAGE_URL = "https://mmoh16.github.io/Student-Manger/";
        window.addEventListener("load", async function () {
            try {
                if (!window.Clerk) { console.error("Clerk missing"); return; }
                await Clerk.load();
                if (Clerk.user) {
                    document.getElementById('appBody').classList.remove('hidden');
                } else {
                    window.location.href = LOGIN_PAGE_URL;
                }
            } catch (err) {
                console.error("Auth Error", err);
                window.location.href = LOGIN_PAGE_URL;
            }
        });
    </script>
</body>
</html>
